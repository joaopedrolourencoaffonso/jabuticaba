<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jabuticaba currículos</title>

    <style>
        
    </style>
</head>
<body>
    <h1>Jabuticaba currículos</h1>

    <input type="text" id="path" name="path" placeholder="C:\seus\arquivos\aqui"><br><br>
    <button onclick="pegarArquivos()">Selecionar diretório</button>
    <br><br>
    <div id="arquivos">
        Aqui aparecerão os arquivos        
    </div>
    <br><br>
    <button onclick="enviarParaAnalise()">Selecionar diretório</button>

    <script>
        function pegarArquivos() {
            let path = document.getElementById("path");
            path = path.value.replaceAll("\\", "\\\\");

            console.log(path);
            sendPath(path);
        }

        async function sendPath(path) {
            console.log("Enviando curriculo para análise...");
            const url = 'http://127.0.0.1:5000/listar_arquivos';  // Replace with your server endpoint
            
            // Send a POST request with the curriculo string
            try {
                const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded', // You can also use 'application/json' if needed
                },
                body: `path=${encodeURIComponent(path)}`, // Encode the curriculo data for safe transmission
                });

                if (response.ok) {
                    console.log('Data sent successfully');
                    const data = await response.json(); // Get the response body tex
                    console.log("Response data:", typeof(data), data);
                    listaArquivos(data);
                } else {
                    console.error('Error:', response.statusText);
                }
            } catch (error) {
                console.error('Request failed', error);
            }
        }

        function listaArquivos(arquivos){
            console.log("listaArquivos: ", arquivos, typeof(arquivos));
            //arquivos = decodeURIComponent(escape(arquivos)); 
            // Get the container div
            let container = document.getElementById("arquivos");
            container.innerHTML = '';

            const br1 = document.createElement("br");
            const br2 = document.createElement("br");
            container.appendChild(br1);
            container.appendChild(br2);

            let lista;
            let liElement;

            //lista = arquivos.replaceAll("[", "").replaceAll("]", "").replaceAll("'", "");
            //lista = lista.replaceAll("\n", "");
            //lista = lista.replaceAll('  "', "").replaceAll('"','').split(",");
            //
            //console.log("arquivos: ", temp, typeof(temp));
            //

            for (let i = 0; i < arquivos.length; i++) {
                const arquivo = arquivos[i];

                const liElement = document.createElement("li");
                liElement.id = `arquivo-${i}`;  // Unique ID for each li
                liElement.textContent = arquivo + " "; // Add some spacing before the button

                const deleteButton = document.createElement("button");
                deleteButton.textContent = "Delete";

                // Add click event to delete this li
                deleteButton.addEventListener("click", () => {
                    liElement.remove();
                });

                liElement.appendChild(deleteButton);
                container.appendChild(liElement);
            }
        }

        async function enviarParaAnalise() {
            //
            let path = document.getElementById("path");
            path = path.value.replaceAll("\\", "\\\\");
            // 
            const container = document.getElementById("arquivos");
            
            if (!container) {
                console.log("No element with ID 'arquivos' found.");
                return;
            }

            const children = container.children;

            //console.log(`Found ${children.length} elements inside #arquivos:`);
            let arquivosParaEnvio = [];
            for (let i = 0; i < children.length; i++) {
                if (children[i].firstChild != null){
                    //console.log("-> ",children[i].firstChild.data);
                    arquivosParaEnvio.push(path + "\\\\" + children[i].firstChild.data);
                }
            }
            console.log("Enviando para análise: ", arquivosParaEnvio);
            const url = 'http://127.0.0.1:5000/enviarAnalise';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ arquivos: arquivosParaEnvio }),  // Wrap in object if needed
                });

                if (response.ok) {
                    const data = await response.json(); // or .text() depending on response
                    console.log("Response from server:", data[0]);
                } else {
                    console.error("Server responded with error:", response.statusText);
                }
            } catch (error) {
                console.error("Error sending request:", error);
            }
        }

    </script>
</body>
</html>